name: Deploy to Server

on:
  push:
    branches:
      - main  # 배포는 main 브랜치에 push 되었을 때만 실행

jobs:
  deploy:
    name: Deploy WAR to Server and Restart Tomcat
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout Source
        uses: actions/checkout@v3

      - name: ☕ Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: 🔨 Build with Maven
        run: mvn clean package -DskipTests

      - name: 📂 Upload WAR to Server
        run: |
          scp target/*.war ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:${{ secrets.REMOTE_DEPLOY_DIR }}/app.war
        env:
          # secrets에 사전 등록 필요
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_DEPLOY_DIR: ${{ secrets.REMOTE_DEPLOY_DIR }}

      - name: 🚀 Restart Tomcat
        run: |
          ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'
            # Tomcat 중지
            systemctl stop tomcat
            sleep 5
            # 기존 war 삭제 및 교체는 서버에서 처리 가능
            # Tomcat 시작
            systemctl start tomcat
          EOF
