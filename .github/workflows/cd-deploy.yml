# âœ… GitHub Actions Workflow ì´ë¦„ ì„¤ì •
name: Deploy to Server

# âœ… main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œë§Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
on:
  push:
    branches:
      - main  # ë°°í¬ëŠ” main ë¸Œëœì¹˜ì—ì„œë§Œ ìˆ˜í–‰

jobs:
  deploy:
    # âœ… Job ì´ë¦„ ë° ì‹¤í–‰ í™˜ê²½ ì§€ì •
    name: Deploy WAR to Server and Restart Tomcat
    runs-on: ubuntu-latest  # GitHubì—ì„œ ì œê³µí•˜ëŠ” Ubuntu ê°€ìƒ í™˜ê²½ì—ì„œ ì‹¤í–‰

    steps:
      # âœ… Step 1: í˜„ì¬ Repositoryì˜ ì†ŒìŠ¤ì½”ë“œë¥¼ Checkout (ê°€ì ¸ì˜¤ê¸°)
      - name: ğŸ“¦ Checkout Source
        uses: actions/checkout@v3  # GitHub ê³µì‹ ì•¡ì…˜ ì‚¬ìš©

      # âœ… Step 2: JDK 11 ì„¤ì • (Maven ë¹Œë“œë¥¼ ìœ„í•œ Java í™˜ê²½ ì„¸íŒ…)
      - name: â˜• Set up JDK 11
        uses: actions/setup-java@v3  # Java í™˜ê²½ ì„¤ì •ì„ ìœ„í•œ ê³µì‹ ì•¡ì…˜
        with:
          java-version: '11'         # ì‚¬ìš©í•  Java ë²„ì „
          distribution: 'temurin'    # ë°°í¬íŒì€ Temurin(OpenJDK ê¸°ë°˜)

      # âœ… Step 3: Maven ë¹Œë“œ (í…ŒìŠ¤íŠ¸ëŠ” ìƒëµí•˜ê³  íŒ¨í‚¤ì§•ë§Œ ìˆ˜í–‰)
      - name: ğŸ”¨ Build with Maven
        run: mvn clean package -DskipTests  # í…ŒìŠ¤íŠ¸ ìƒëµí•˜ê³  .war íŒŒì¼ ìƒì„±

      # âœ… Step 4: ìƒì„±ëœ WAR íŒŒì¼ì„ ì›ê²© ì„œë²„ë¡œ ì „ì†¡ (scp ì‚¬ìš©)
      - name: ğŸ“‚ Upload WAR to Server
        run: |
          # `target` í´ë”ì˜ .war íŒŒì¼ì„ app.war ë¡œ ì´ë¦„ ì§€ì •í•˜ì—¬ ì„œë²„ë¡œ ì „ì†¡
          scp target/*.war ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:${{ secrets.REMOTE_DEPLOY_DIR }}/app.war
        env:
          # GitHub Secrets ì—ì„œ ì„¤ì •í•œ ê°’ë“¤ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì£¼ì…
          REMOTE_USER: ${{ secrets.REMOTE_USER }}              # ì›ê²© ì„œë²„ì˜ ì‚¬ìš©ì ì´ë¦„
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}              # ì›ê²© ì„œë²„ì˜ IP ë˜ëŠ” ë„ë©”ì¸
          REMOTE_DEPLOY_DIR: ${{ secrets.REMOTE_DEPLOY_DIR }}  # .war íŒŒì¼ì´ ë°°í¬ë  ë””ë ‰í† ë¦¬ ê²½ë¡œ

      # âœ… Step 5: ì›ê²© ì„œë²„ì— ì ‘ì†í•˜ì—¬ Tomcat ì„œë²„ë¥¼ ì¬ì‹œì‘
      - name: ğŸš€ Restart Tomcat
        run: |
          # SSHë¥¼ í†µí•´ ì„œë²„ì— ì ‘ì† í›„ ëª…ë ¹ì–´ ì‹¤í–‰
          ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'
            # Tomcat ì„œë²„ ì¤‘ì§€
            systemctl stop tomcat
            sleep 5  # ì ì‹œ ëŒ€ê¸° (ì™„ì „íˆ ì¢…ë£Œë˜ë„ë¡)

            # Tomcatì€ ì§€ì •ëœ í´ë”(app.war)ë¥¼ ìë™ìœ¼ë¡œ ì¬ë°°í¬í•˜ë¯€ë¡œ ë³„ë„ ì¡°ì¹˜ ì—†ì´ ì‹œì‘ë§Œ í•˜ë©´ ë¨
            systemctl start tomcat  # Tomcat ì„œë²„ ì‹œì‘
          EOF