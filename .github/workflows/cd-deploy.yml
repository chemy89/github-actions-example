name: Deploy to Server

on:
  push:
    branches:
      - main  # ë°°í¬ëŠ” main ë¸Œëœì¹˜ì— push ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰

jobs:
  deploy:
    name: Deploy WAR to Server and Restart Tomcat
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout Source
        uses: actions/checkout@v3

      - name: â˜• Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: ğŸ”¨ Build with Maven
        run: mvn clean package -DskipTests

      - name: ğŸ“‚ Upload WAR to Server
        run: |
          scp target/*.war ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:${{ secrets.REMOTE_DEPLOY_DIR }}/app.war
        env:
          # secretsì— ì‚¬ì „ ë“±ë¡ í•„ìš”
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_DEPLOY_DIR: ${{ secrets.REMOTE_DEPLOY_DIR }}

      - name: ğŸš€ Restart Tomcat
        run: |
          ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'
            # Tomcat ì¤‘ì§€
            systemctl stop tomcat
            sleep 5
            # ê¸°ì¡´ war ì‚­ì œ ë° êµì²´ëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬ ê°€ëŠ¥
            # Tomcat ì‹œì‘
            systemctl start tomcat
          EOF
